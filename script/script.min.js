import{saveTeam,saveResult,getNames}from"./data.js";let map=null;elementExistByID("map")&&initMap();let currentIndex=0;const teamName=getTeamNameLocal();function attachAnswerListeners(){removeClassFromElements("quiz","quizLocked");const answers=document.querySelectorAll(".answer");let qidForRadio="";answers.forEach(box=>{box.addEventListener("click",()=>{answers.forEach(b=>{const parentElement=box.parentElement,classNames=parentElement.classList,qid=classNames[1],abc=document.querySelectorAll(".options."+qid+" .answer");abc.forEach(def=>{def.classList.remove("answer-selected")}),qidForRadio=qid}),box.classList.add("answer-selected");let www,ele,boxNum=box.id.split("-")[1];const correspondingRadio=document.querySelector(`input[id="${qidForRadio}${boxNum}"]`);correspondingRadio.checked=!0})})}function addZero(i){return i<10&&(i="0"+i),i}function getDateStamp(){const d=new Date;let year,month,day,hour,min,sec,timeStamp;return`${d.getFullYear()}-${addZero(d.getMonth()+1)}-${addZero(d.getDate())} ${addZero(d.getHours())}:${addZero(d.getMinutes())}:${addZero(d.getSeconds())}`}function displayCurrentItem(){if("undefined"==typeof steps)return;const previousButton=document.getElementById("previousButton");previousButton.style.opacity=0==currentIndex?"0.1":"1";const nextButton=document.getElementById("nextButton");if(currentIndex>=21){nextButton.style.opacity="0.11",previousButton.style.opacity="0.01";const continueMessage=document.getElementById("continuePrompt");continueMessage.style.display="none";const contquizWrapperinueMessage=document.getElementById("quizWrapper");quizWrapper.style.display="none";const scoreWrap=document.getElementById("finalScore");scoreWrap.style.display="flex";const theScore=document.getElementById("w_theScore");var totalScore=getLocalData("totalScore");theScore.innerHTML=`<span class='counter' style='--from:0; --to:${totalScore}; --time:4s;'></span>`}else{nextButton.style.opacity="1";const scoreWrap=document.getElementById("finalScore");scoreWrap.style.display="none"}let attemptedSection=!1;if(currentIndex>=0&&currentIndex<steps.length){const currentItem=steps[currentIndex],resultDiv=document.getElementById("w_result"),w_titleDiv=document.getElementById("w_title"),w_contentDiv=document.getElementById("w_content"),w_image=document.getElementById("w_image"),w_directions=document.getElementById("w_directions"),w_quiz=document.getElementById("w_quiz"),w_infoDiv=document.getElementById("w_info"),w_warningDiv=document.getElementById("w_warning"),w_mediaDiv1=document.getElementById("w_media_1"),w_selfieDiv=document.getElementById("w_selfie"),b_checkAnswers=document.getElementById("btnCheckAnswers");w_titleDiv.innerHTML=`${currentItem.name}`,w_contentDiv.innerHTML=`${currentItem.place}`,w_image.innerHTML=`<img src='assets/img/${currentItem.image}'>`,currentItem.video&&(w_image.innerHTML=`<div style="padding:56.25% 0 0 0;position:relative;"><iframe src="${currentItem.video}" frameborder="0" allow="autoplay" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="BTM wapping RAW"></iframe></div><script src="https://player.vimeo.com/api/player.js"><\/script>`),""!=currentItem.info?w_infoDiv.innerHTML=`${currentItem.info}`:w_infoDiv.innerHTML="",""!=currentItem.access?w_warningDiv.innerHTML=`${currentItem.access}`:w_warningDiv.innerHTML="",""!=currentItem.selfie?w_selfieDiv.innerHTML='<div class="button" onclick="cameraToggleLocal();">Take a Selfie...<br />get the location in the background!</div>':w_selfieDiv.innerHTML="",""!=currentItem.audio_direction?w_directions.innerHTML=`<div class="directions-wrap"> <div class="audio-cntr"><audio id="audioDirections" controls controlsList="nodownload"><source src="${currentItem.audio_direction}" type="audio/mp3"></audio></div></div>`:w_directions.innerHTML="";const lat=currentItem.lat,lon=currentItem.lon;var marker=(new mapboxgl.Marker).setLngLat([lon,lat]).addTo(map);map.easeTo({zoom:17,center:[lon,lat],bearing:-10,duration:1e3,easing:x=>x});let subChildHtml="",maxQuestionNum=0;for(const key in currentItem.questions)if(currentItem.questions.hasOwnProperty(key)){let qid=extractQuestionID(currentItem.questions[key]),questionAndAnswer=removeQuestionID(currentItem.questions[key]),question=removeTextInBrackets(questionAndAnswer),answers=extractTextBetweenBrackets(questionAndAnswer),answerOptions="",radioOptions="",answerNum=1;answers.split(",").forEach((function(item){let correctAnswer,correctFlag="0";isTheAnswer(item)&&(correctFlag="1",item=item.slice(0,item.length-1)),answerOptions+='<div data-correct="'+correctFlag+'" class="answer answer-enable" id="q'+qid+answerNum+'">'+item+"</div>",radioOptions+='<input type="radio" name="boxRadio-opt-'+qid+'" id="opt-'+qid+answerNum+'" value="q'+qid+answerNum+'">',answerNum++})),subChildHtml+='<div class="q-title">QUESTION '+qid+"</div>",subChildHtml+=`<p class="question">${question}</p>`,subChildHtml+=`<div class="options opt-${qid}">${answerOptions}</div>`,subChildHtml+=`<div id="radioForm" class="hide">${radioOptions}</div>`,maxQuestionNum=qid}"0"!=maxQuestionNum&&(attemptedSection=getLocalData("q"+maxQuestionNum+"4")),""==subChildHtml?(subChildHtml+="<h3>Take a break, there are no questions for this stage...</h3>",b_checkAnswers.style.display="none"):b_checkAnswers.style.display="block",w_quiz.innerHTML=subChildHtml,""!=currentItem.audio_talk?w_mediaDiv1.innerHTML=`<div class="audio-wrap"><div class="dr-green"><img src="img/dr-green.png"></div><div class="audio-cntr"><audio id="myAudio1" controls controlsList="nodownload"><source src="${currentItem.audio_talk}" type="audio/mp3"></audio></div></div>`:w_mediaDiv1.innerHTML="",w_contentDiv.classList.remove("content-hidden")}attachAnswerListeners(),attemptedSection&&(removeAnswerHandler(),addClassToElements("quiz","quizLocked"),btnCheckAnswers.style.display="none"),resetAnimations()}displayCurrentItem();const coordinates=document.getElementById("coord");function getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition):coordinates.innerHTML="Geolocation is not supported or not allowed on this device."}function showPosition(position){const lat=position.coords.latitude,lon=position.coords.longitude,el=document.createElement("div");el.className="markerYou",new mapboxgl.Marker(el).setLngLat([lon,lat]).addTo(map),map.easeTo({zoom:17,center:[lon,lat],easing:x=>x})}function isTheAnswer(str){return str.endsWith("*")}function resetAnimations(){addClassToElements("answer","answer-enable")}function addClassToElements(className,newClass){const elements=document.getElementsByClassName(className);for(let i=0;i<elements.length;i++)elements[i].classList.add(newClass)}function removeClassFromElements(className,newClass){const elements=document.getElementsByClassName(className);for(let i=0;i<elements.length;i++)elements[i].classList.remove(newClass)}function mapToggle(){var mapDiv;document.getElementById("map").classList.toggle("mapOpen")}function cameraToggle(){var cameraDiv;document.getElementById("camera").classList.toggle("cameraOpen")}function directionsPlayToggle(){var player=document.getElementById("audioDirections");player.classList.toggle("playing"),togglePlayPause(player);var iconDirVol=document.getElementById("iconDirVol");let curState=iconDirVol.innerHTML;iconDirVol.innerHTML="volume_up"==curState?"volume_off":"volume_up"}function audioReset(){var player=document.getElementById("audioDirections");player.pause(),player.currentItem=0,player.src=""}function stepForward(){currentIndex<steps.length-1&&(currentIndex++,displayCurrentItem()),scrollToTop()}function stepBackward(){currentIndex>0&&(currentIndex--,displayCurrentItem()),scrollToTop()}function openDrawer(){document.getElementById("drawer").classList.add("open")}function closeDrawer(){document.getElementById("drawer").classList.remove("open")}function scrollToTop(){window.scrollTo(0,0)}function togglePlayPause(audioElement){audioElement.paused?audioElement.play():audioElement.pause()}function fadePageToBlack(){var overlay;document.getElementById("overlay").style.opacity="1"}function extractQuestionID(inputString){const extractedText=inputString.substring(0,4);return extractedText}function extractTextBetweenBrackets(inputString){const startIndex=inputString.indexOf("["),endIndex=inputString.indexOf("]");if(-1!==startIndex&&-1!==endIndex){const extractedText=inputString.substring(startIndex+1,endIndex);return extractedText}return null}function removeQuestionID(inputString){const extractedText=inputString.slice(4,inputString.length);return extractedText}function removeTextInBrackets(inputString){const startIndex=inputString.indexOf("["),endIndex=inputString.indexOf("]");return-1!==startIndex&&-1!==endIndex?inputString.substring(0,startIndex)+inputString.substring(endIndex+1):inputString}function setTeamNameLocal(teamName){setLocalData("team_name",teamName),setLocalData("totalScore",0)}function getTeamNameLocal(){return getLocalData("team_name")}function setLocalData(key,data){localStorage.setItem(key,data)}function getLocalData(key){return localStorage.getItem(key)}function createX(teamName){setTeamNameLocal(teamName),saveTeam(getDateStamp()+"|"+teamName)}function removeAnswerHandler(){const answers=document.querySelectorAll(".answer");answers.forEach(box=>{let newBox=box.cloneNode(!0);box.parentNode.replaceChild(newBox,box),box=newBox})}function checkAnswers(){let answerText="",questionNum=1,questionId="",correctCount=0;const myDialogEle=document.getElementById("myDialog");myDialogEle.showModal();const dialogMessageEle=document.getElementById("dialogMessage");dialogMessageEle.innerHTML="<h4>Checking your answers...</h4>";const questions=document.querySelectorAll(".options");questions.forEach(question=>{const answers=question.children;let notAttempted=!0,correctAnswer=!1;for(let i=0;i<answers.length;i++){let choice=answers[i],id=choice.getAttribute("id"),selected=isAnswerChosen(choice.getAttribute("class")),correct=!!+choice.getAttribute("data-correct");selected&&(notAttempted=!1),selected&correct&&(correctAnswer=!0,correctCount++),correct&&choice.classList.add("true-answer"),questionId=id}answerText+="<li>",answerText+="("+questionId+") Q"+questionNum+". ",answerText+=notAttempted?"Not answered":correctAnswer?"<span class='correct'>Correct</span>":"<span class='wrong'>Wrong</span>",answerText+="</li>",questionNum++}),dialogMessageEle.innerHTML+="<ul class='check'>"+answerText+"</ul>";let answerTextComp=answerText;answerTextComp=answerTextComp.replaceAll("Not answered","NA"),answerTextComp=answerTextComp.replaceAll("</li>",","),answerTextComp=answerTextComp.replace(/(<([^>]+)>)/gi,"");let compResult=getDateStamp()+"|"+teamName+"|"+answerTextComp;return saveResult(compResult),setLocalData(questionId,!0),removeAnswerHandler(),addClassToElements("quiz","quizLocked"),btnCheckAnswers.style.display="none",correctCount}function isAnswerChosen(str){return str.toLowerCase().includes("answer-selected")}function elementExistByID(id){let element;return!!!!document.getElementById(id)}function initMap(){mapboxgl.accessToken="pk.eyJ1IjoicGF1bHN0dXJuIiwiYSI6ImNsb29xNjhsYTAzMWMyaWs0MnhmcnkwemMifQ.QGAyREqnB3rSzZTZoevDQw",map=new mapboxgl.Map({container:"map",style:"mapbox://styles/paulsturn/clor4p1kl00ni01pbg0en5pa4",center:[-.0704913,51.5065202],zoom:16,bearing:10}),map.easeTo({zoom:16,bearing:-10,duration:7e3,easing:x=>x})}function updateScore(){const scoreEle=document.getElementById("teamScore");scoreEle.textContent=getLocalData("totalScore"),removeClassFromElements("score","flashScore"),addClassToElements("score","flashScore")}const addTeam=document.getElementById("addTeamName"),previousButton=document.getElementById("previousButton"),nextButton=document.getElementById("nextButton"),mapSwitch=document.getElementById("mapToggle"),cameraSwitch=document.getElementById("cameraToggle"),directionsSwitch=document.getElementById("directionsToggle"),myLocationSwitch=document.getElementById("myLocation"),btnCheckAnswers=document.getElementById("btnCheckAnswers");addTeam.addEventListener("click",()=>{const teamName=document.getElementById("teamName");if(teamName.value){createX(teamName.value);const myDialogEle=document.getElementById("myDialog");myDialog.showModal();const dialogMessageEle=document.getElementById("dialogMessage");dialogMessageEle.innerHTML="<br /><br /><h3>Thank you</h3><p>Your teamname has been saved.</p>";const start=document.getElementById("btn-start");start.style.display="block"}else{const myDialogEle=document.getElementById("myDialog");myDialogEle.showModal();const dialogMessageEle=document.getElementById("dialogMessage");dialogMessageEle.innerHTML="<br /><br /><h3>Please enter a team name!</h3><p>We use the team name you enter to save your quiz score.</p>"}}),myLocationSwitch.addEventListener("click",()=>{getLocation()}),previousButton.addEventListener("click",()=>{stepBackward()}),nextButton.addEventListener("click",()=>{let allowed=!0,hasQuestions=!1;const w_quiz=document.getElementById("w_quiz"),quest=document.querySelector(".question");if(w_quiz.contains(quest)){hasQuestions=!0;const qWrapper=document.getElementById("quizWrapper");qWrapper.classList.contains("quizLocked")||(allowed=!1)}if(allowed)stepForward();else{const warning=document.getElementById("myDialog");warning.showModal();const warningMessageEle=document.getElementById("dialogMessage");warningMessageEle.innerHTML="<br /><br /><h3>Quiz answers not checked</h3><p>Click 'CHECK ANSWERS' button to check your quiz answers.</p>"}}),mapSwitch.addEventListener("click",()=>{mapToggle()}),directionsSwitch.addEventListener("click",()=>{directionsPlayToggle()}),btnCheckAnswers.addEventListener("click",()=>{let correct=checkAnswers(),score=getLocalData("totalScore"),newScore;"NaN"==score&&(score=0,setLocalData("totalScore",score)),setLocalData("totalScore",parseInt(score)+parseInt(correct)),updateScore()});